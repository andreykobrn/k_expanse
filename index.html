<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Расход</title>
    <!-- Подключаем Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Используем CSS переменные Telegram для нативной темы */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 16px;
            box-sizing: border-box;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h3 {
            margin-top: 0;
            color: var(--tg-theme-hint-color, #888);
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .form-row {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--tg-theme-bg-color, #e0e0e0); /* Разделитель цветом фона */
            padding: 0 16px;
        }

        .form-row:last-child {
            border-bottom: none;
        }

        label {
            width: 100px;
            color: var(--tg-theme-text-color);
            font-size: 16px;
        }

        input, select, textarea {
            flex: 1;
            padding: 14px 0;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--tg-theme-text-color);
            outline: none;
            font-family: inherit;
        }

        input::placeholder, textarea::placeholder {
            color: var(--tg-theme-hint-color, #a8a8a8);
        }

        /* Убираем стрелку у select для чистоты, или оставляем */
        select {
            -webkit-appearance: none;
            background-image: none;
        }
        
        /* Спиннер загрузки */
        .loader {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: var(--tg-theme-link-color, #2481cc);
        }
        
        /* Анимация ошибки/успеха */
        .status-msg {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        .error { color: #ff3b30; }
        .success { color: #34c759; }

    </style>
</head>
<body>
    <div class="container">
        <!-- Блок суммы и категории -->
        <h3>Основные данные</h3>
        <div class="card">
            <div class="form-row">
                <input type="number" id="amount" placeholder="Сумма (₽)" style="font-size: 20px; font-weight: 500;" inputmode="decimal" autofocus>
            </div>
            <div class="form-row">
                <select id="category">
                    <option value="" disabled selected>Категория</option>
                    <option value="Отдых с удовольствием">Отдых с удовольствием</option>
                    <option value="Продукты сверх лимита">Продукты сверх лимита</option>
                    <option value="Подписки">Подписки</option>
                    <option value="Хозтовары">Хозтовары</option>
                    <option value="Бензин">Бензин</option>
                    <option value="Медицина">Медицина</option>
                    <option value="Косметика">Косметика</option>
                    <option value="Бьюти">Бьюти</option>
                    <option value="Одежда">Одежда</option>
                    <option value="Подарки">Подарки</option>
                    <option value="Обучение">Обучение</option>
                    <option value="Квартира">Квартира</option>
                    <option value="Кредиты">Кредиты</option>
                    <option value="Другое">Другое</option>
                </select>
            </div>
        </div>

        <!-- Блок деталей -->
        <h3>Детали</h3>
        <div class="card">
            <div class="form-row">
                <input type="text" id="name" placeholder="Название (необязательно)">
            </div>
            <div class="form-row">
                <textarea id="comment" rows="2" placeholder="Комментарий..."></textarea>
            </div>
        </div>
        
        <div class="loader" id="loader">Сохранение...</div>
        <div class="status-msg" id="statusMsg"></div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // 1. Сначала расширяем приложение
        tg.expand();

        // 2. Настраиваем параметры кнопки (используем setParams для надежности)
        tg.MainButton.setParams({
            text: "СОХРАНИТЬ РАСХОД",
            color: tg.themeParams.button_color || "#2481cc",
            text_color: tg.themeParams.button_text_color || "#ffffff",
            is_active: true,
            is_visible: true
        });

        // URL твоего Google Apps Script (сохранил твой URL)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1v7EUrUGUjGUtGlPKj873xYvint16peIsaS06e9tX_eJHb1t3f9SjkS8gNtKOSnj1/exec";

        // Обработка клика по главной кнопке
        tg.MainButton.onClick(function() {
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const name = document.getElementById('name').value;
            const comment = document.getElementById('comment').value;

            // Валидация
            if (!amount) {
                tg.HapticFeedback.notificationOccurred('error');
                showStatus("Введите сумму!", "error");
                document.getElementById('amount').focus();
                return;
            }
            if (!category) {
                tg.HapticFeedback.notificationOccurred('error');
                showStatus("Выберите категорию!", "error");
                document.getElementById('category').focus();
                return;
            }

            sendData({
                amount: amount,
                category: category,
                name: name,
                comment: comment,
                telegram_id: tg.initDataUnsafe?.user?.id,
                username: tg.initDataUnsafe?.user?.username
            });
        });

function sendData(data) {
    tg.MainButton.showProgress();
    const btnHtml = document.getElementById('btn-submit');
    if(btnHtml) {
        btnHtml.disabled = true;
        btnHtml.textContent = "Сохраняю...";
    }
    document.getElementById('loader').style.display = 'block';
    document.getElementById('statusMsg').style.display = 'none';

    // ВАЖНО: Убрали mode: 'no-cors' и оставили text/plain
    fetch(APPSSCRIPTURL, {
        method: "POST",
        headers: {
            "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        // Проверяем статус ответа
        if (!response.ok) {
            throw new Error(`Ошибка сети: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        // Логика успеха
        if (result.success) {
            tg.MainButton.hideProgress();
            if(btnHtml) {
                btnHtml.disabled = false;
                btnHtml.textContent = "Сохранить";
            }
            document.getElementById('loader').style.display = 'none';
            
            tg.HapticFeedback.notificationOccurred('success');
            showStatus('Сохранено!', 'success');
            
            // Очистка полей
            document.getElementById('amount').value = '';
            document.getElementById('name').value = '';
            document.getElementById('comment').value = '';
            
            // Закрытие приложения (опционально)
            if (tg.platform !== 'unknown' && tg.platform !== 'web') {
                 setTimeout(() => tg.close(), 1000);
            }
        } else {
            throw new Error(result.error || "Неизвестная ошибка скрипта");
        }
    })
    .catch(error => {
        console.error("Error", error);
        tg.MainButton.hideProgress();
        if(btnHtml) {
            btnHtml.disabled = false;
            btnHtml.textContent = "Сохранить";
        }
        document.getElementById('loader').style.display = 'none';
        tg.HapticFeedback.notificationOccurred('error');
        showStatus("Ошибка: " + error.message, "error");
    });
}


        function showStatus(text, type) {
            const el = document.getElementById('statusMsg');
            el.textContent = text;
            el.className = "status-msg " + type;
            el.style.display = "block";
        }

        // 3. Самое важное: сообщаем, что приложение готово к показу
        // Это часто исправляет проблему с неотображением элементов
        tg.ready();
    </script>
</body>

</html>



